<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Petfinder — Registro</title>
    <link rel="stylesheet" href="/assets/css/landing.css" />
    <style>
      /* Improve legibility for the country dropdown on light option popups */
  #countryCode { background:#ffffff; color:#111111; border:1px solid #d1d5db; color-scheme: light; }
  #countryCode:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.25); border-color:#93c5fd; }
  /* Many browsers render option lists with a white popup; enforce dark text */
  #countryCode option { color:#111111; background:#ffffff; }

  /* Fix low-contrast text in the Sex dropdown on white popups */
  #sex { background:#ffffff; color:#111111; border:1px solid #d1d5db; color-scheme: light; }
  #sex:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.25); border-color:#93c5fd; }
  #sex option { color:#111111; background:#ffffff; }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner" style="max-width:720px;">
        <a class="brand" href="/">
          <span class="brand-mark">🐾</span>
          <span class="brand-name">Petfinder</span>
        </a>
  <nav class="main-nav"><a href="/shop">Tienda</a><a href="/blog">Blog</a><span id="hdrName" style="opacity:.9;"></span></nav>
      </div>
    </header>

    <main class="section">
      <div class="container" style="max-width:720px;">
        <h1>Crear cuenta</h1>
        <p class="hero-subtitle">Regístrate para administrar tus mascotas y generar códigos QR.</p>

  <form id="registerForm" class="demo-form" novalidate>
          <label class="demo-label" for="name">Nombre completo</label>
          <input class="input" id="name" name="name" type="text" required placeholder="Tu nombre" />

          <label class="demo-label" for="last_name">Apellido</label>
          <input class="input" id="last_name" name="last_name" type="text" placeholder="Tu apellido" />
          <label class="demo-label" for="sex">Sexo</label>
          <select class="input" id="sex" name="sex">
            <option value="unknown">Prefiero no decir</option>
            <option value="male">Masculino</option>
            <option value="female">Femenino</option>
          </select>

          <label class="demo-label" for="email">Correo electrónico</label>
          <input class="input" id="email" name="email" type="email" required placeholder="tu@correo.com" />
          <div id="emailError" class="demo-help" style="color:#fca5a5;display:none;margin-bottom:8px"></div>
          <script>
            const emailInput = document.getElementById('email');
            const emailError = document.getElementById('emailError');
            emailInput.addEventListener('input', function () {
              if (!emailInput.validity.valid) {
                emailError.textContent = 'Ingresa un correo electrónico válido';
                emailError.style.display = 'block';
              } else {
                emailError.textContent = '';
                emailError.style.display = 'none';
              }
            });
          </script>

          <label class="demo-label" for="phone">Teléfono</label>
          <div class="demo-inputs">
            <select class="input" id="countryCode" name="countryCode" aria-label="Código de país">
              <option value="+57">🇨🇴 +57 (Colombia)</option>
              <option value="+52">🇲🇽 +52 (México)</option>
              <option value="+54">🇦🇷 +54 (Argentina)</option>
              <option value="+56">🇨🇱 +56 (Chile)</option>
              <option value="+51">🇵🇪 +51 (Perú)</option>
              <option value="+34">🇪🇸 +34 (España)</option>
              <option value="+1">🇺🇸 +1 (Estados Unidos)</option>
              <option value="+593">🇪🇨 +593 (Ecuador)</option>
              <option value="+598">🇺🇾 +598 (Uruguay)</option>
              <option value="+505">🇳🇮 +505 (Nicaragua)</option>
              <option value="+507">🇵🇦 +507 (Panamá)</option>
              <option value="+58">🇻🇪 +58 (Venezuela)</option>
            </select>
            <input class="input" id="phone" name="phone" type="tel" required placeholder="Número sin prefijo" inputmode="numeric" />
          </div>
          <!-- Se eliminan restricciones de formato/largo en teléfono -->

          <label class="demo-label" for="citySelect">Ciudad</label>
          <div id="cityGroup">
            <div id="deptWrap" style="display:none; margin-bottom:8px;">
              <label class="demo-label" for="deptSelect">Departamento (Colombia)</label>
              <select class="input" id="deptSelect" aria-label="Departamento"></select>
            </div>
            <select class="input" id="citySelect" name="citySelect" required aria-label="Ciudad"></select>
            <input class="input" id="cityOther" name="cityOther" type="text" placeholder="Especifica tu ciudad" style="display:none; margin-top:8px;" />
            <div class="demo-help">Selecciona tu ciudad según el país del teléfono. Para Colombia, elige primero el departamento.</div>
          </div>

          <label class="demo-label" for="password">Contraseña</label>
          <div class="field-with-icon">
            <input class="input" id="password" name="password" type="password" required minlength="6" placeholder="Mínimo 6 caracteres" />
            <button type="button" id="pwToggle" class="icon-toggle" aria-label="Mostrar contraseña mientras se presiona" title="Mantén presionado para ver">👁️</button>
          </div>
          <label class="demo-label" for="confirm_password">Confirmar contraseña</label>
          <div class="field-with-icon">
            <input class="input" id="confirm_password" name="confirm_password" type="password" required minlength="6" placeholder="Repite la contraseña" />
            <button type="button" id="pwToggle2" class="icon-toggle" aria-label="Mostrar confirmación mientras se presiona" title="Mantén presionado para ver">👁️</button>
          </div>
          <div id="pwdError" class="demo-help" style="color:#fca5a5;display:none;margin-bottom:8px"></div>

          <label class="demo-label" for="instagram_url">Instagram (opcional)</label>
          <input class="input" id="instagram_url" name="instagram_url" type="url" placeholder="https://instagram.com/tu_usuario" />

          <label class="demo-label" for="facebook_url">Facebook (opcional)</label>
          <input class="input" id="facebook_url" name="facebook_url" type="url" placeholder="https://facebook.com/tu.perfil" />

          <label class="demo-label" for="whatsapp_url">WhatsApp (opcional)</label>
          <input class="input" id="whatsapp_url" name="whatsapp_url" type="url" placeholder="https://wa.me/XXXXXXXXXXX" />

          <label class="demo-label" for="referred_by_code">Código de referido (opcional)</label>
          <input class="input" id="referred_by_code" name="referred_by_code" type="text" placeholder="Si alguien te refirió, pega su código aquí" />

          <button class="button button-primary" id="submitBtn" type="submit">Crear cuenta</button>
          <p style="margin-top:8px">¿Ya tienes cuenta? <a href="/login">Inicia sesión</a></p>

          <div id="message" class="demo-help" role="status" aria-live="polite" style="margin-top:10px"></div>
        </form>

      </div>
    </main>

      <footer class="site-footer">
        <div class="container footer-inner" style="max-width:720px;">
          <div class="footer-credit">Creado por Mike Rodríguez</div>
          <nav class="footer-nav" aria-label="Footer">
            <a href="https://github.com/mikerb95" target="_blank" rel="noopener">GitHub</a>
            <a href="/terms">Términos</a>
            <a href="/privacy">Privacidad</a>
            <a href="/license">Licencia</a>
          </nav>
        </div>
      </footer>

  <script src="/assets/js/header-user.js" defer></script>
  <script>
      (function () {
        // Press-and-hold reveal for passwords
        (function(){
          function bindHold(btnId, inputId){
            const btn = document.getElementById(btnId);
            const input = document.getElementById(inputId);
            if (!btn || !input) return;
            const show = () => { input.setAttribute('type','text'); };
            const hide = () => { input.setAttribute('type','password'); };
            btn.addEventListener('mousedown', show);
            btn.addEventListener('mouseup', hide);
            btn.addEventListener('mouseleave', hide);
            btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); show(); }, {passive:false});
            btn.addEventListener('touchend', hide);
          }
          bindHold('pwToggle','password');
          bindHold('pwToggle2','confirm_password');
        })();
          // If already logged, go to dashboard
          try {
            const t = localStorage.getItem('auth_token');
            if (t) window.location.replace('/dashboard');
          } catch (_) {}

        // Show header name if logged in
        try {
          const t = localStorage.getItem('auth_token');
          if (t) {
            fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + t } })
              .then(r => r.json())
              .then(d => { if (d?.user?.name) { const el = document.getElementById('hdrName'); if (el) el.textContent = 'Hola, ' + d.user.name; } })
              .catch(() => {});
          }
        } catch(_) {}

  const form = document.getElementById('registerForm');
        
        const msg = document.getElementById('message');
        const btn = document.getElementById('submitBtn');
        function setMessage(text, ok) {
          msg.textContent = text;
          msg.style.color = ok ? '#22c55e' : '#fca5a5';
        }
        form.addEventListener('submit', async function (e) {
          e.preventDefault();
          setMessage('', true);
          btn.disabled = true; btn.textContent = 'Creando…';
          const cc = document.getElementById('countryCode');
          const phoneRaw = document.getElementById('phone').value.trim();
          if (!phoneRaw) { setMessage('Ingresa un teléfono', false); btn.disabled = false; btn.textContent = 'Crear cuenta'; return; }
          const payload = {
            name: document.getElementById('name').value.trim(),
            last_name: document.getElementById('last_name').value.trim() || undefined,
            sex: document.getElementById('sex').value,
            email: document.getElementById('email').value.trim(),
            phone: ((cc && cc.value ? cc.value + ' ' : '') + phoneRaw) || undefined,
            password: document.getElementById('password').value,
            confirm_password: document.getElementById('confirm_password').value,
            instagram_url: document.getElementById('instagram_url').value.trim() || undefined,
            facebook_url: document.getElementById('facebook_url').value.trim() || undefined,
            whatsapp_url: document.getElementById('whatsapp_url').value.trim() || undefined,
            referred_by_code: document.getElementById('referred_by_code').value.trim() || undefined
          };
          // City from dependent dropdowns
          (function(){
            const ccVal = (cc && cc.value) || '';
            const citySel = document.getElementById('citySelect');
            const other = document.getElementById('cityOther');
            let city = '';
            if (citySel && citySel.value === 'other') city = (other?.value || '').trim();
            else city = citySel?.value || '';
            if (!city) { setMessage('Selecciona tu ciudad', false); btn.disabled = false; btn.textContent = 'Crear cuenta'; return; }
            payload.city = city;
          })();
          // client-side password match validation
          const pwdError = document.getElementById('pwdError');
          if (payload.password !== payload.confirm_password) {
            if (pwdError) { pwdError.textContent = 'Las contraseñas no coinciden'; pwdError.style.display = 'block'; }
            btn.disabled = false; btn.textContent = 'Crear cuenta';
            return;
          } else { if (pwdError) pwdError.style.display = 'none'; }
          try {
            const res = await fetch('/api/auth/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
              const base = data && data.error ? data.error : 'Error al registrar';
              const extra = data && data.detail ? ` (${data.detail})` : '';
              throw new Error(base + extra);
            }
            // Old flow restored: store token and redirect
            if (data && data.token) localStorage.setItem('auth_token', data.token);
            setMessage('Cuenta creada correctamente. Redirigiendo…', true);
            setTimeout(() => { window.location.href = '/'; }, 900);
          } catch (err) {
            setMessage(err.message || 'Error al registrar', false);
          } finally {
            btn.disabled = false; btn.textContent = 'Crear cuenta';
          }
        });
        
        // City/Department lists and wiring
        (function setupCityDropdown(){
          const DATA = {
            '+57': { co: true, deps: {
              'Antioquia': ['Medellín','Bello','Envigado','Itagüí','Rionegro'],
              'Cundinamarca': ['Bogotá','Soacha','Chía','Zipaquirá'],
              'Valle del Cauca': ['Cali','Palmira','Buenaventura','Tuluá'],
              'Atlántico': ['Barranquilla','Soledad','Malambo'],
              'Santander': ['Bucaramanga','Floridablanca','Girón','Piedecuesta'],
              'Bolívar': ['Cartagena','Turbaco'],
              'Risaralda': ['Pereira','Dosquebradas'],
              'Caldas': ['Manizales','Villamaría'],
              'Tolima': ['Ibagué','Espinal'],
              'Nariño': ['Pasto','Ipiales']
            } },
            '+52': ['Ciudad de México','Guadalajara','Monterrey','Puebla','Tijuana','León','Querétaro','Mérida','Cancún'],
            '+54': ['Buenos Aires','Córdoba','Rosario','Mendoza','La Plata','Mar del Plata'],
            '+56': ['Santiago','Valparaíso','Viña del Mar','Concepción','La Serena','Antofagasta'],
            '+51': ['Lima','Arequipa','Trujillo','Chiclayo','Piura','Cusco'],
            '+34': ['Madrid','Barcelona','Valencia','Sevilla','Zaragoza','Málaga','Murcia','Palma'],
            '+1': ['New York','Los Angeles','Chicago','Miami','Houston','Dallas','San Francisco','Seattle'],
            '+593': ['Quito','Guayaquil','Cuenca','Santo Domingo','Machala'],
            '+598': ['Montevideo','Salto','Paysandú','Las Piedras','Rivera'],
            '+505': ['Managua','León','Masaya','Chinandega','Matagalpa'],
            '+507': ['Ciudad de Panamá','Colón','David','Santiago'],
            '+58': ['Caracas','Maracaibo','Valencia','Barquisimeto','Maracay']
          };
          const cc = document.getElementById('countryCode');
          const deptWrap = document.getElementById('deptWrap');
          const dept = document.getElementById('deptSelect');
          const city = document.getElementById('citySelect');
          const other = document.getElementById('cityOther');
          function renderCities(){
            const code = cc?.value || '';
            other.style.display = 'none'; other.value = '';
            city.innerHTML = '';
            if (DATA[code] && DATA[code].co) {
              // Colombia
              deptWrap.style.display = '';
              const deps = Object.keys(DATA[code].deps);
              dept.innerHTML = deps.map(d=>`<option value="${d}">${d}</option>`).join('');
              const first = dept.value || deps[0];
              const cities = DATA[code].deps[first] || [];
              city.innerHTML = cities.map(c=>`<option value="${c}">${c}</option>`).join('') + '<option value="other">Otra…</option>';
            } else {
              deptWrap.style.display = 'none';
              const cities = Array.isArray(DATA[code]) ? DATA[code] : [];
              city.innerHTML = cities.map(c=>`<option value="${c}">${c}</option>`).join('') + '<option value="other">Otra…</option>';
            }
          }
          function renderCitiesForDep(){
            const code = cc?.value || '';
            if (!(DATA[code] && DATA[code].co)) return;
            const cities = DATA[code].deps[dept.value] || [];
            city.innerHTML = cities.map(c=>`<option value="${c}">${c}</option>`).join('') + '<option value="other">Otra…</option>';
          }
          cc?.addEventListener('change', renderCities);
          dept?.addEventListener('change', renderCitiesForDep);
          city?.addEventListener('change', ()=>{ other.style.display = (city.value==='other') ? '' : 'none'; if (city.value !== 'other') other.value = ''; });
          // init
          renderCities();
        })();

        // Prefill referral code from URL (?ref=XXXX)
        (function prefillReferral(){
          try {
            const url = new URL(window.location.href);
            const ref = url.searchParams.get('ref') || url.searchParams.get('referred_by_code');
            if (ref) {
              const input = document.getElementById('referred_by_code');
              if (input) input.value = ref.trim();
            }
          } catch(_) {}
        })();

        // Mensajes de validacion en español (HTML5)
        (function attachSpanishValidation(){
          function setMessage(el){
            el.setCustomValidity('');
            const v = el.validity; if (v.valid) return;
            let msg = '';
            if (v.valueMissing) msg = 'Este campo es obligatorio';
            else if (v.typeMismatch) {
              const type = (el.getAttribute('type')||'').toLowerCase();
              if (type === 'email') msg = 'Ingresa un correo electrónico válido';
              else if (type === 'url') msg = 'Ingresa una URL válida (https://...)';
              else if (type === 'tel') msg = 'Ingresa un número de teléfono válido';
              else msg = 'Ingresa un valor válido';
            } else if (v.patternMismatch) msg = 'El formato no es válido';
            else if (v.tooShort) msg = 'Debe tener al menos ' + (el.minLength || '') + ' caracteres';
            else if (v.tooLong) msg = 'Debe tener como máximo ' + (el.maxLength || '') + ' caracteres';
            else if (v.rangeUnderflow) msg = 'El valor debe ser al menos ' + (el.min || '');
            else if (v.rangeOverflow) msg = 'El valor debe ser como máximo ' + (el.max || '');
            else if (v.stepMismatch) msg = 'Selecciona un valor válido';
            else if (v.badInput) msg = 'Ingresa un valor válido';
            el.setCustomValidity(msg);
          }
          const formEl = document.getElementById('registerForm');
          const all = formEl ? formEl.querySelectorAll('input, select, textarea') : document.querySelectorAll('input, select, textarea');
          all.forEach(el => {
            el.addEventListener('invalid', (e) => setMessage(e.target));
            el.addEventListener('input', (e) => e.target.setCustomValidity(''));
          });
        })();
      })();
    </script>
  </body>
  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments) };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
  </html>
