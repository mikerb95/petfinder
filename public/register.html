<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Petfinder — Registro</title>
    <link rel="stylesheet" href="/assets/css/landing.css" />
    <style>
      /* Improve legibility for the country dropdown on light option popups */
  #countryCode { background:#ffffff; color:#111111; border:1px solid #d1d5db; color-scheme: light; }
  #countryCode:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.25); border-color:#93c5fd; }
  /* Many browsers render option lists with a white popup; enforce dark text */
  #countryCode option { color:#111111; background:#ffffff; }

  /* Fix low-contrast text in the Sex dropdown on white popups */
  #sex { background:#ffffff; color:#111111; border:1px solid #d1d5db; color-scheme: light; }
  #sex:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.25); border-color:#93c5fd; }
  #sex option { color:#111111; background:#ffffff; }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner" style="max-width:720px;">
        <a class="brand" href="/">
          <span class="brand-mark">🐾</span>
          <span class="brand-name">Petfinder</span>
        </a>
  <nav class="main-nav"><span id="hdrName" style="opacity:.9;"></span></nav>
      </div>
    </header>

    <main class="section">
      <div class="container" style="max-width:720px;">
        <h1>Crear cuenta</h1>
        <p class="hero-subtitle">Regístrate para administrar tus mascotas y generar códigos QR.</p>

  <form id="registerForm" class="demo-form" novalidate>
          <label class="demo-label" for="name">Nombre completo</label>
          <input class="input" id="name" name="name" type="text" required placeholder="Tu nombre" />

          <label class="demo-label" for="last_name">Apellido</label>
          <input class="input" id="last_name" name="last_name" type="text" placeholder="Tu apellido" />
          <label class="demo-label" for="sex">Sexo</label>
          <select class="input" id="sex" name="sex">
            <option value="unknown">Prefiero no decir</option>
            <option value="male">Masculino</option>
            <option value="female">Femenino</option>
          </select>

          <label class="demo-label" for="email">Correo electrónico</label>
          <input class="input" id="email" name="email" type="email" required placeholder="tu@correo.com" />
          <div id="emailError" class="demo-help" style="color:#fca5a5;display:none;margin-bottom:8px"></div>
          <script>
            const emailInput = document.getElementById('email');
            const emailError = document.getElementById('emailError');
            emailInput.addEventListener('input', function () {
              if (!emailInput.validity.valid) {
                emailError.textContent = 'Ingresa un correo electrónico válido';
                emailError.style.display = 'block';
              } else {
                emailError.textContent = '';
                emailError.style.display = 'none';
              }
            });
          </script>

          <label class="demo-label" for="phone">Teléfono</label>
          <div class="demo-inputs">
            <select class="input" id="countryCode" name="countryCode" aria-label="Código de país">
              <option value="+57">🇨🇴 +57 (Colombia)</option>
              <option value="+52">🇲🇽 +52 (México)</option>
              <option value="+54">🇦🇷 +54 (Argentina)</option>
              <option value="+56">🇨🇱 +56 (Chile)</option>
              <option value="+51">🇵🇪 +51 (Perú)</option>
              <option value="+34">🇪🇸 +34 (España)</option>
              <option value="+1">🇺🇸 +1 (Estados Unidos)</option>
              <option value="+593">🇪🇨 +593 (Ecuador)</option>
              <option value="+598">🇺🇾 +598 (Uruguay)</option>
              <option value="+505">🇳🇮 +505 (Nicaragua)</option>
              <option value="+507">🇵🇦 +507 (Panamá)</option>
              <option value="+58">🇻🇪 +58 (Venezuela)</option>
            </select>
            <input class="input" id="phone" name="phone" type="tel" required placeholder="Número de teléfono" />
          </div>
          <!-- Se eliminan restricciones de formato/largo en teléfono -->

          <label class="demo-label" for="password">Contraseña</label>
          <input class="input" id="password" name="password" type="password" required minlength="6" placeholder="Mínimo 6 caracteres" />
          <label class="demo-label" for="confirm_password">Confirmar contraseña</label>
          <input class="input" id="confirm_password" name="confirm_password" type="password" required minlength="6" placeholder="Repite la contraseña" />
          <div id="pwdError" class="demo-help" style="color:#fca5a5;display:none;margin-bottom:8px"></div>

          <button class="button button-primary" id="submitBtn" type="submit">Crear cuenta</button>
          <p style="margin-top:8px">¿Ya tienes cuenta? <a href="/login">Inicia sesión</a></p>

          <div id="message" class="demo-help" role="status" aria-live="polite" style="margin-top:10px"></div>
        </form>

        <form id="verifyForm" class="demo-form" style="display:none; margin-top:20px" novalidate>
          <h3>Verifica tu correo</h3>
          <p class="hero-subtitle">Hemos enviado un código de 6 dígitos a tu correo. Escríbelo para activar tu cuenta.</p>
          <label class="demo-label" for="vcode">Código de verificación</label>
          <input class="input" id="vcode" name="vcode" type="text" inputmode="numeric" pattern="[0-9]{6}" placeholder="000000" maxlength="6" />
          <button class="button button-primary" id="verifyBtn" type="submit">Verificar</button>
          <div id="verifyMsg" class="demo-help" role="status" aria-live="polite" style="margin-top:10px"></div>
        </form>
      </div>
    </main>

      <footer class="site-footer">
        <div class="container footer-inner" style="max-width:720px;">
          <div class="footer-credit">Creado por Mike Rodríguez</div>
          <nav class="footer-nav" aria-label="Footer">
            <a href="https://github.com/mikerb95" target="_blank" rel="noopener">GitHub</a>
            <a href="/terms">Términos</a>
            <a href="/privacy">Privacidad</a>
          </nav>
        </div>
      </footer>

    <script>
      (function () {
          // If already logged, go to dashboard
          try {
            const t = localStorage.getItem('auth_token');
            if (t) window.location.replace('/dashboard');
          } catch (_) {}

        // Show header name if logged in
        try {
          const t = localStorage.getItem('auth_token');
          if (t) {
            fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + t } })
              .then(r => r.json())
              .then(d => { if (d?.user?.name) { const el = document.getElementById('hdrName'); if (el) el.textContent = 'Hola, ' + d.user.name; } })
              .catch(() => {});
          }
        } catch(_) {}

  const form = document.getElementById('registerForm');
  const verifyForm = document.getElementById('verifyForm');
  const verifyMsg = document.getElementById('verifyMsg');
  const verifyBtn = document.getElementById('verifyBtn');
  let pendingEmail = '';
  function setVerifyMessage(text, ok) { verifyMsg.textContent = text; verifyMsg.style.color = ok ? '#22c55e' : '#fca5a5'; }
        const msg = document.getElementById('message');
        const btn = document.getElementById('submitBtn');
        function setMessage(text, ok) {
          msg.textContent = text;
          msg.style.color = ok ? '#22c55e' : '#fca5a5';
        }
        form.addEventListener('submit', async function (e) {
          e.preventDefault();
          setMessage('', true);
          btn.disabled = true; btn.textContent = 'Creando…';
          const cc = document.getElementById('countryCode');
          const phoneRaw = document.getElementById('phone').value.trim();
          if (!phoneRaw) { setMessage('Ingresa un teléfono', false); btn.disabled = false; btn.textContent = 'Crear cuenta'; return; }
          const payload = {
            name: document.getElementById('name').value.trim(),
            last_name: document.getElementById('last_name').value.trim() || undefined,
            sex: document.getElementById('sex').value,
            email: document.getElementById('email').value.trim(),
            phone: ((cc && cc.value ? cc.value + ' ' : '') + phoneRaw) || undefined,
            password: document.getElementById('password').value,
            confirm_password: document.getElementById('confirm_password').value
          };
          // client-side password match validation
          const pwdError = document.getElementById('pwdError');
          if (payload.password !== payload.confirm_password) {
            if (pwdError) { pwdError.textContent = 'Las contraseñas no coinciden'; pwdError.style.display = 'block'; }
            btn.disabled = false; btn.textContent = 'Crear cuenta';
            return;
          } else { if (pwdError) pwdError.style.display = 'none'; }
          try {
            const res = await fetch('/api/auth/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
              const base = data && data.error ? data.error : 'Error al registrar';
              const extra = data && data.detail ? ` (${data.detail})` : '';
              throw new Error(base + extra);
            }
            // New flow: prompt for verification code
            pendingEmail = payload.email;
            setMessage('Cuenta creada. Revisa tu correo para el código de verificación.', true);
            form.style.display = 'none';
            verifyForm.style.display = '';
            // In non-production, the backend may return verification_code for testing
            if (data && data.verification_code) {
              const v = document.getElementById('vcode'); if (v) v.value = data.verification_code;
            }
          } catch (err) {
            setMessage(err.message || 'Error al registrar', false);
          } finally {
            btn.disabled = false; btn.textContent = 'Crear cuenta';
          }
        });
        // Verify form submit handler
        verifyForm.addEventListener('submit', async function(e){
          e.preventDefault();
          setVerifyMessage('', true);
          verifyBtn.disabled = true; verifyBtn.textContent = 'Verificando…';
          try {
            const code = (document.getElementById('vcode').value || '').trim();
            const res = await fetch('/api/auth/verify', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: pendingEmail, code })
            });
            const data = await res.json().catch(()=>({}));
            if (!res.ok) throw new Error(data?.error || 'No se pudo verificar');
            if (data && data.token) localStorage.setItem('auth_token', data.token);
            setVerifyMessage('Correo verificado. Redirigiendo…', true);
            setTimeout(() => { window.location.href = '/'; }, 900);
          } catch (err) {
            setVerifyMessage(err.message || 'Error al verificar', false);
          } finally {
            verifyBtn.disabled = false; verifyBtn.textContent = 'Verificar';
          }
        });

        // Mensajes de validacion en español (HTML5)
        (function attachSpanishValidation(){
          function setMessage(el){
            el.setCustomValidity('');
            const v = el.validity; if (v.valid) return;
            let msg = '';
            if (v.valueMissing) msg = 'Este campo es obligatorio';
            else if (v.typeMismatch) {
              const type = (el.getAttribute('type')||'').toLowerCase();
              if (type === 'email') msg = 'Ingresa un correo electrónico válido';
              else if (type === 'url') msg = 'Ingresa una URL válida (https://...)';
              else if (type === 'tel') msg = 'Ingresa un número de teléfono válido';
              else msg = 'Ingresa un valor válido';
            } else if (v.patternMismatch) msg = 'El formato no es válido';
            else if (v.tooShort) msg = 'Debe tener al menos ' + (el.minLength || '') + ' caracteres';
            else if (v.tooLong) msg = 'Debe tener como máximo ' + (el.maxLength || '') + ' caracteres';
            else if (v.rangeUnderflow) msg = 'El valor debe ser al menos ' + (el.min || '');
            else if (v.rangeOverflow) msg = 'El valor debe ser como máximo ' + (el.max || '');
            else if (v.stepMismatch) msg = 'Selecciona un valor válido';
            else if (v.badInput) msg = 'Ingresa un valor válido';
            el.setCustomValidity(msg);
          }
          const formEl = document.getElementById('registerForm');
          const all = formEl ? formEl.querySelectorAll('input, select, textarea') : document.querySelectorAll('input, select, textarea');
          all.forEach(el => {
            el.addEventListener('invalid', (e) => setMessage(e.target));
            el.addEventListener('input', (e) => e.target.setCustomValidity(''));
          });
        })();
      })();
    </script>
  </body>
  </html>
