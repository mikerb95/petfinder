<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carrito ‚Äî Petfinder</title>
  <link rel="stylesheet" href="/assets/css/landing.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner" style="max-width:720px;">
      <a class="brand" href="/">
        <span class="brand-mark">üêæ</span>
        <span class="brand-name">Petfinder</span>
      </a>
  <nav class="main-nav"><a href="/shop">Tienda</a><a href="/cart" id="cartLink" style="position:relative;">Carrito <span id="cartCount" style="position:absolute;top:-6px;right:-10px;background:#ef4444;color:#fff;border-radius:999px;padding:0 6px;font-size:12px;line-height:18px;min-width:18px;text-align:center;display:none;">0</span></a><a href="/blog">Blog</a><a id="hdrLogin" href="/login">Ingresar</a><span id="hdrName" style="margin-left:8px;opacity:.9;"></span></nav>
    </div>
  </header>
  <main class="section">
    <div class="container" style="max-width:720px;">
      <h1>Carrito de compras</h1>
      <div id="cartItems"></div>
      <div id="cartTotal" style="font-size:1.2em;margin:16px 0;"></div>
      <a href="/checkout" class="button button-primary">Ir al checkout</a>
    </div>
  </main>
  <footer class="site-footer">
    <div class="container footer-inner" style="max-width:720px;">
      <div class="footer-credit">Creado por Mike Rodr√≠guez</div>
      <nav class="footer-nav" aria-label="Footer">
        <a href="https://github.com/mikerb95" target="_blank" rel="noopener">GitHub</a>
        <a href="/terms">T√©rminos</a>
        <a href="/privacy">Privacidad</a>
        <a href="/license">Licencia</a>
      </nav>
    </div>
  </footer>
  <script src="/assets/js/header-user.js" defer></script>
  <script>
    (async function(){
      try{
        const r = await fetch('/api/cart', {credentials:'include'});
        const d = await r.json().catch(()=>({}));
        const n = (d.items||[]).reduce((a,it)=>a+Number(it.quantity||0),0);
        const el = document.getElementById('cartCount');
        if (el) { if (n>0){ el.textContent=String(n); el.style.display='inline-block'; } else el.style.display='none'; }
      }catch(_){ }
    })();
    async function loadCart() {
      const res = await fetch('/api/cart');
      const data = await res.json();
      const items = data.items || [];
      const el = document.getElementById('cartItems');
      el.innerHTML = '';
      // update badge
      (function(){
        try{
          const count = items.reduce((a,it)=>a+Number(it.quantity||0),0);
          const badge = document.getElementById('cartCount');
          if (badge) { if (count>0){ badge.textContent=String(count); badge.style.display='inline-block'; } else badge.style.display='none'; }
        }catch(_){ }
      })();
      if (!items.length) { el.innerHTML = '<div class="demo-help">Tu carrito est√° vac√≠o.</div>'; document.getElementById('cartTotal').textContent = ''; return; }
  let total = 0;
      items.forEach(item => {
        total += item.price_cents * item.quantity;
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <img src="${item.image_url}" alt="${item.name}" class="card-cover" style="max-height:80px;object-fit:cover;" />
          <div class="card-body">
            <h2 class="card-title">${item.name}</h2>
            <div style="display:flex;align-items:center;gap:8px;">
              <span>Cantidad:</span>
              <div class="qty-stepper" style="display:inline-flex;align-items:center;border:1px solid rgba(255,255,255,0.15);border-radius:10px;overflow:hidden;">
                <button class="button" type="button" data-dec="${item.product_id}" aria-label="Disminuir" style="border:0;border-right:1px solid rgba(255,255,255,0.12);padding:6px 10px;line-height:1;">‚àí</button>
                <input class="input" type="number" min="1" max="${item.stock}" value="${item.quantity}" data-id="${item.product_id}" style="width:64px;border:0;text-align:center;box-shadow:none;margin:0;border-radius:0;" />
                <button class="button" type="button" data-inc="${item.product_id}" aria-label="Aumentar" style="border:0;border-left:1px solid rgba(255,255,255,0.12);padding:6px 10px;line-height:1;">+</button>
              </div>
            </div>
    <div>Precio unitario: ${new Intl.NumberFormat('es-CO',{style:'currency',currency:item.currency||'COP'}).format(item.price_cents/100)}</div>
    <div>Subtotal: ${new Intl.NumberFormat('es-CO',{style:'currency',currency:item.currency||'COP'}).format((item.price_cents*item.quantity)/100)}</div>
            <button class="button" data-remove="${item.product_id}">Eliminar</button>
          </div>
        `;
        el.appendChild(div);
      });
  document.getElementById('cartTotal').textContent = 'Total: ' + new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP'}).format(total/100);
      // Actualizar cantidad manual en input
      el.querySelectorAll('input[type=number]').forEach(inp => {
        inp.onchange = async function() {
          const pid = inp.getAttribute('data-id');
          const qty = Math.max(1, Math.min(Number(inp.value), 99));
          await fetch('/api/cart', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_id: pid, quantity: qty })
          });
          loadCart();
        };
      });
      // Botones + / -
      el.querySelectorAll('button[data-inc], button[data-dec]').forEach(btn => {
        btn.onclick = async function(){
          const pid = btn.getAttribute('data-inc') || btn.getAttribute('data-dec');
          const card = btn.closest('.card');
          const inp = card && card.querySelector('input[data-id="'+pid+'"]');
          if (!inp) return;
          const max = Math.max(1, parseInt(inp.getAttribute('max')||'99', 10));
          const cur = Math.max(1, parseInt(inp.value||'1', 10));
          const next = btn.hasAttribute('data-inc') ? Math.min(cur+1, max) : Math.max(cur-1, 1);
          if (next === cur) return;
          inp.value = String(next);
          await fetch('/api/cart', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_id: pid, quantity: next })
          });
          loadCart();
        };
      });
      // Eliminar
      el.querySelectorAll('button[data-remove]').forEach(btn => {
        btn.onclick = async function() {
          const pid = btn.getAttribute('data-remove');
          await fetch('/api/cart', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_id: pid })
          });
          loadCart();
        };
      });
    }
    loadCart();
  </script>
  <script>
    // Mostrar nombre en el header si hay sesi√≥n iniciada
    (async function(){
      try {
        const t = localStorage.getItem('auth_token');
        if (!t) return;
        const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + t } });
        if (!res.ok) return;
        const data = await res.json().catch(()=>({}));
        const name = data && data.user && data.user.name;
        if (name) {
          const el = document.getElementById('hdrName');
          if (el) el.textContent = 'Hola, ' + name;
          const login = document.getElementById('loginLink');
          if (login) login.style.display = 'none';
        }
      } catch(_){ }
    })();
  </script>
</body>
</html>
