<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mascota ‚Äî Petfinder</title>
    <link rel="stylesheet" href="/assets/css/landing.css" />
    <style>
      body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
      .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
  /* Ensure dark text on white card for readability */
  .card, .card h1, .card h2, .card h3, .card p, .card li, .card a, .card dl { color:#111; }
  .card .button { color:#111; background:#fff; border:1px solid #cfcfcf; }
  .card .button:hover { border-color:#9a9a9a; }
      .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600; }
      .badge.lost { background:#ffe6e6; color:#a40000; border:1px solid #ffb3b3; }
      .badge.home { background:#e6fff2; color:#046d36; border:1px solid #b3ffd7; }
      .kv { display:grid; grid-template-columns: 160px 1fr; gap:8px 12px; align-items:baseline; }
      .kv dt { color:#555; }
      .kv dd { margin:0; color:#111; }
      .actions a { text-decoration:none; }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="/">
          <span class="brand-mark">üêæ</span>
          <span class="brand-name">Petfinder</span>
        </a>
      </div>
    </header>

    <main class="section">
      <div class="container" style="max-width:900px;">
        <div id="alert" class="feature-item" style="display:none; border-left:4px solid #c00; background:#fff5f5;"></div>
        <h1 id="title">Mascota</h1>
        <p class="hero-subtitle">Detalles de la mascota y contacto del propietario.</p>

        <div id="content" class="card" style="display:none;">
          <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
            <img id="petPhoto" alt="Foto de la mascota" style="display:none; width:260px; height:260px; object-fit:cover; border-radius:12px; background:#f3f3f3;" />
            <div style="flex:1 1 300px;">
              <h2 id="petName" style="margin:0 0 8px 0;">‚Äî</h2>
              <div id="statusWrap" style="margin-bottom:12px;"></div>
              <dl class="kv">
                <dt>Especie</dt><dd id="petSpecies">‚Äî</dd>
                <dt>Raza</dt><dd id="petBreed">‚Äî</dd>
                <dt>Color</dt><dd id="petColor">‚Äî</dd>
                <dt>Notas</dt><dd id="petNotes">‚Äî</dd>
              </dl>
            </div>
          </div>
          <hr style="margin:16px 0; border:none; border-top:1px solid #eee;" />
          <h3>Contacto del propietario</h3>
          <dl class="kv">
            <dt>Nombre</dt><dd id="ownerName">‚Äî</dd>
            <dt>Tel√©fono</dt><dd id="ownerPhone">‚Äî</dd>
            <dt>Correo</dt><dd id="ownerEmail">‚Äî</dd>
          </dl>
          <div class="actions" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
            <a id="callBtn" class="button" href="#" style="display:none;">Llamar</a>
            <a id="smsBtn" class="button" href="#" style="display:none;">Enviar SMS</a>
            <a id="mailBtn" class="button" href="#" style="display:none;">Enviar correo</a>
          </div>
        </div>
      </div>
    </main>

    <script>
      (function () {
  if (window.__petPageInit) return; // prevent double init
  window.__petPageInit = true;
        function $(id){ return document.getElementById(id); }
        function setText(id, val){ const el=$(id); if (el) el.textContent = val || '‚Äî'; }
        function showAlert(msg){ const a=$('alert'); a.textContent = msg; a.style.display='block'; }

        // Get qrId from URL: /p/:qrId
        var qrId = (location.pathname.split('/')[2] || '').trim();
        if (!qrId) {
          showAlert('No se proporcion√≥ un identificador de mascota.');
          return;
        }

        fetch('/api/pets/public/' + encodeURIComponent(qrId))
          .then(async (res) => {
            if (!res.ok) {
              if (res.status === 404) throw new Error('No se encontr√≥ esta mascota.');
              let msg = 'No se pudo cargar la informaci√≥n.';
              try { const e = await res.json(); if (e && e.error) msg += ' ' + e.error; } catch {}
              throw new Error(msg);
            }
            return res.json();
          })
          .then((data) => {
            $('content').style.display = 'block';
            // Pet
            setText('petName', data.pet?.name || '‚Äî');
            setText('title', data.pet?.name ? ('Mascota: ' + data.pet.name) : 'Mascota');
            setText('petSpecies', data.pet?.species || '‚Äî');
            setText('petBreed', data.pet?.breed || '‚Äî');
            setText('petColor', data.pet?.color || '‚Äî');
            setText('petNotes', data.pet?.notes || '‚Äî');
            if (data.pet?.photo_url) {
              var img = $('petPhoto'); img.src = data.pet.photo_url; img.style.display='block';
            }
            var statusWrap = $('statusWrap');
            if (statusWrap) statusWrap.innerHTML = '';
            if (data.pet?.status && statusWrap) {
              var badge = document.createElement('span');
              badge.className = 'badge ' + (data.pet.status === 'lost' ? 'lost' : 'home');
              badge.textContent = data.pet.status === 'lost' ? 'Perdida' : 'En casa';
              statusWrap.appendChild(badge);
            }
            // Owner
            setText('ownerName', data.owner?.name || '‚Äî');
            setText('ownerPhone', data.owner?.phone || '‚Äî');
            setText('ownerEmail', data.owner?.email || '‚Äî');
            if (data.owner?.phone) {
              $('callBtn').href = 'tel:' + data.owner.phone; $('callBtn').style.display='inline-block';
              $('smsBtn').href = 'sms:' + data.owner.phone; $('smsBtn').style.display='inline-block';
            }
            if (data.owner?.email) {
              $('mailBtn').href = 'mailto:' + data.owner.email + '?subject=Mascota%20encontrada'; $('mailBtn').style.display='inline-block';
            }
          })
          .catch((err) => {
            showAlert(err.message || 'No se pudo cargar la informaci√≥n.');
          });
      })();
    </script>
  </body>
  </html>
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mascota encontrada ‚Äî Petfinder</title>
    <link rel="stylesheet" href="/assets/css/landing.css" />
    <style>
      .pet-card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
      .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.85rem}
      .badge-home{background:#eaf7ea;color:#157e36}
      .badge-lost{background:#ffefef;color:#b30000}
      .grid{display:grid;gap:16px}
      @media(min-width:720px){.grid{grid-template-columns:1.2fr .8fr}}
      .pet-photo{width:100%;max-height:360px;object-fit:cover;border-radius:10px;background:#f6f6f6}
      .meta{color:#444}
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="/">
          <span class="brand-mark">üêæ</span>
          <span class="brand-name">Petfinder</span>
        </a>
      </div>
    </header>

    <main class="section">
      <div class="container" style="max-width:960px;">
        <h1 id="title">Mascota encontrada</h1>
        <p>Gracias por escanear el c√≥digo. Usa estos datos para contactar a su propietario.</p>

        <div id="content" class="grid">
          <div class="pet-card">
            <img id="photo" class="pet-photo" alt="Mascota" />
            <h2 id="petName"></h2>
            <p class="meta" id="petMeta"></p>
            <p class="meta" id="petNotes"></p>
            <span id="status" class="badge"></span>
          </div>
          <div class="pet-card">
            <h3>Contacto del propietario</h3>
            <p><strong>Nombre:</strong> <span id="ownerName"></span></p>
            <p><strong>Tel√©fono:</strong> <a id="ownerPhone"></a></p>
            <p><strong>Correo:</strong> <a id="ownerEmail"></a></p>
            <p><a class="button" href="/">Volver al inicio</a></p>
          </div>
        </div>

        <div id="notFound" class="feature-item" style="display:none;">
          <h3>No encontrado</h3>
          <p>El c√≥digo no corresponde a ninguna mascota. Verifica el QR o contacta al propietario.</p>
          <p><a class="button" href="/">Volver</a></p>
        </div>
      </div>
    </main>

    <script>
      (function(){
        const parts = window.location.pathname.split('/');
        const qrId = parts[2] || '';
        const content = document.getElementById('content');
        const notFound = document.getElementById('notFound');
        fetch('/api/pets/public/' + encodeURIComponent(qrId))
          .then(async r => {
            if (!r.ok) throw new Error('not found');
            return r.json();
          })
          .then(d => {
            const pet = d.pet || {}; const owner = d.owner || {};
            document.getElementById('petName').textContent = pet.name || 'Mascota';
            const parts = [];
            if (pet.species) parts.push('Especie: ' + pet.species);
            if (pet.breed) parts.push('Raza: ' + pet.breed);
            if (pet.color) parts.push('Color: ' + pet.color);
            document.getElementById('petMeta').textContent = parts.join(' | ');
            document.getElementById('petNotes').textContent = pet.notes ? ('Notas: ' + pet.notes) : '';
            const status = document.getElementById('status');
            if (pet.status === 'lost') { status.textContent = 'Perdida'; status.className = 'badge badge-lost'; }
            else { status.textContent = 'En casa'; status.className = 'badge badge-home'; }
            const photo = document.getElementById('photo');
            if (pet.photo_url) { photo.src = pet.photo_url; photo.style.display='block'; }
            else { photo.style.display='none'; }
            document.getElementById('ownerName').textContent = owner.name || '';
            const phoneA = document.getElementById('ownerPhone');
            phoneA.textContent = owner.phone || 'No disponible';
            phoneA.href = owner.phone ? ('tel:' + owner.phone) : '#';
            const emailA = document.getElementById('ownerEmail');
            emailA.textContent = owner.email || 'No disponible';
            emailA.href = owner.email ? ('mailto:' + owner.email) : '#';
          })
          .catch(() => { content.style.display = 'none'; notFound.style.display = 'block'; });
      })();
    </script>
  </body>
</html>
