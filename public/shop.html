<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tienda — Petfinder</title>
    <link rel="stylesheet" href="/assets/css/landing.css" />
    <style>
      .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
      .tabs .tab{border:1px solid rgba(255,255,255,0.14);border-radius:999px;padding:6px 12px;background:transparent;color:var(--color-text);cursor:pointer}
      .tabs .tab[aria-pressed="true"], .tabs .tab.active{background:#0b1220;border-color:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,0.25) inset}
      .empty{color:#9ca3af;padding:16px;border:1px dashed rgba(255,255,255,0.14);border-radius:12px;text-align:center}
    </style>
  </head>
  <body>
  <header class="site-header"><div class="container header-inner"><a class="brand" href="/">🐾 Petfinder</a><nav class="main-nav"><a href="/shop">Tienda</a><a href="/cart" id="cartLink" style="position:relative;">🛒<span id="cartCount" style="position:absolute;top:-6px;right:-10px;background:#ef4444;color:#fff;border-radius:999px;padding:0 6px;font-size:12px;line-height:18px;min-width:18px;text-align:center;display:none;">0</span></a><a href="/blog">Blog</a><a id="hdrLogin" href="/login">Ingresar</a><span id="hdrName" style="margin-left:8px;opacity:.9;"></span></nav></div></header>
    <main class="container" style="padding:20px 0;">
      <h1>Tienda</h1>
      <nav class="tabs" aria-label="Filtrar por especie">
        <button id="tabAll" class="tab" type="button" aria-pressed="true">Todos</button>
        <button id="tabDogs" class="tab" type="button" aria-pressed="false">🐶 Perros</button>
        <button id="tabCats" class="tab" type="button" aria-pressed="false">🐱 Gatos</button>
      </nav>
      <div id="viewTitle" class="muted" style="margin: -6px 0 8px"></div>
      <div id="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;"></div>
    </main>
    <div class="container" style="padding: 8px 12px 16px; text-align:center;">
      <a href="/license" style="color:#9ca3af; text-decoration:none;">Licencia</a>
    </div>
    <script src="/assets/js/header-user.js" defer></script>
    <script>
      // Vista en la misma página: Todos | Perros | Gatos (sin crear nuevas páginas)
      let allProducts = [];
      function getFilterFromHash(){
        const h = (location.hash || '').toLowerCase();
        if (h.includes('perros') || h.includes('dogs') || h === '#perros' || h === '#dogs') return 'dogs';
        if (h.includes('gatos') || h.includes('cats') || h === '#gatos' || h === '#cats') return 'cats';
        return 'all';
      }
      function inferKind(p){
        const text = ((p.name||'') + ' ' + (p.description||'')).toLowerCase();
        const dogKw = ['perro','perros','dog','dogs','canino','caninos','canina'];
        const catKw = ['gato','gatos','cat','cats','felino','felinos','felina'];
        const isDog = dogKw.some(k=>text.includes(k));
        const isCat = catKw.some(k=>text.includes(k));
        if (isDog && !isCat) return 'dogs';
        if (isCat && !isDog) return 'cats';
        return 'other';
      }
      function updateTabsUI(filter){
        const map = { all: 'tabAll', dogs: 'tabDogs', cats: 'tabCats' };
        ['tabAll','tabDogs','tabCats'].forEach(id=>{
          const el = document.getElementById(id);
          if (!el) return;
          const active = map[filter] === id;
          el.classList.toggle('active', active);
          el.setAttribute('aria-pressed', active ? 'true' : 'false');
        });
        const vt = document.getElementById('viewTitle');
        vt.textContent = filter === 'dogs' ? 'Artículos para perros' : filter === 'cats' ? 'Artículos para gatos' : '';
      }
      function render(filter='all'){
        updateTabsUI(filter);
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const list = (allProducts||[]).filter(p=>{
          const k = inferKind(p);
          if (filter === 'dogs') return k === 'dogs';
          if (filter === 'cats') return k === 'cats';
          return true;
        });
        if (!list.length){
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'No hay productos para este filtro.';
          grid.appendChild(empty);
          return;
        }
        list.forEach(p=>{
          const kind = inferKind(p);
          const icon = kind === 'dogs' ? '🐶' : kind === 'cats' ? '🐱' : '📦';
          const card = document.createElement('a');
          card.href = '/shop/' + encodeURIComponent(p.slug);
          card.style = 'border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:14px;text-decoration:none;color:inherit;';
          card.innerHTML = `
            <div style="height:140px;background:rgba(255,255,255,0.06);border-radius:10px;margin-bottom:10px;display:grid;place-items:center">${icon}</div>
            <h3 style="margin:0 0 6px">${p.name}</h3>
            <div style="color:#9ca3af">${p.currency} ${(p.price_cents/100).toLocaleString('es-CO')}</div>`;
          grid.appendChild(card);
        });
      }
      async function initShop(){
        try{
          const res = await fetch('/api/shop/products');
          const data = await res.json();
          allProducts = data.products||[];
        } catch(_) { allProducts = []; }
        const filter = getFilterFromHash();
        render(filter);
      }
      // Tab events
      document.addEventListener('DOMContentLoaded', ()=>{
        const tabAll = document.getElementById('tabAll');
        const tabDogs = document.getElementById('tabDogs');
        const tabCats = document.getElementById('tabCats');
        tabAll?.addEventListener('click', ()=>{ history.replaceState(null,'','#'); render('all'); });
        tabDogs?.addEventListener('click', ()=>{ location.hash = '#perros'; render('dogs'); });
        tabCats?.addEventListener('click', ()=>{ location.hash = '#gatos'; render('cats'); });
        window.addEventListener('hashchange', ()=>{ render(getFilterFromHash()); });
      });
      initShop();
    </script>
    <script>
      (async function(){
        try{
          const r = await fetch('/api/cart', {credentials:'include'});
          const d = await r.json().catch(()=>({}));
          const n = (d.items||[]).reduce((a,it)=>a+Number(it.quantity||0),0);
          const el = document.getElementById('cartCount');
          if (el) { if (n>0){ el.textContent=String(n); el.style.display='inline-block'; } else el.style.display='none'; }
        }catch(_){ }
      })();
    </script>
    <script>
      // Mostrar nombre en el header si hay sesión iniciada
      (async function(){
        try {
          const t = localStorage.getItem('auth_token');
          if (!t) return;
          const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + t } });
          if (!res.ok) return;
          const data = await res.json().catch(()=>({}));
          const name = data && data.user && data.user.name;
          if (name) {
            const el = document.getElementById('hdrName');
            if (el) el.textContent = 'Hola, ' + name;
            const login = document.getElementById('loginLink');
            if (login) login.style.display = 'none';
          }
        } catch(_){ }
      })();
    </script>
  </body>
</html>
