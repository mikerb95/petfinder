<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editor - Blog</title>
  <link rel="stylesheet" href="/assets/css/landing.css" />
  <style>
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1 1 220px}
    textarea{min-height: 320px}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/"><span class="brand-mark">üêæ</span><span class="brand-name">Petfinder</span></a>
      <nav class="main-nav">
        <a href="/shop">Tienda</a>
        <a href="/blog">Blog</a>
        <a id="loginLink" href="/login">Ingresar</a>
        <span id="userWrap" style="position:relative;display:inline-block;">
          <button id="userMenuBtn" type="button" class="button" style="display:none;">Hola, <span id="userName"></span> ‚ñæ</button>
          <div id="userMenu" class="card" style="position:absolute;right:0;top:calc(100% + 8px);min-width:180px;display:none;z-index:50;">
            <div class="card-body" style="display:flex;flex-direction:column;gap:6px;">
              <a class="button" href="/dashboard">Panel</a>
              <button id="logoutBtn" class="button" type="button">Cerrar sesi√≥n</button>
            </div>
          </div>
        </span>
      </nav>
    </div>
  </header>
  <main class="section">
    <div class="container" style="max-width:900px;">
      <a href="/blog" class="link">‚Üê Volver</a>
      <h1>Editor de Blog</h1>
      <div class="row">
        <input class="input grow" id="title" placeholder="T√≠tulo" />
        <input class="input" id="slug" placeholder="slug-auto" style="max-width:240px" />
        <select class="input" id="status" style="max-width:220px">
          <option value="draft">Borrador</option>
          <option value="published">Publicado</option>
          <option value="archived">Archivado</option>
        </select>
      </div>
      <textarea class="input" id="content" rows="14" placeholder="Contenido..."></textarea>
      <div class="row">
        <input class="input grow" id="excerpt" placeholder="Extracto (opcional)" />
        <input class="input grow" id="cover_image_url" placeholder="URL de portada (opcional)" />
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
        <button class="button" id="save">Guardar</button>
        <span class="muted" id="autosave"></span>
      </div>
    </div>
  </main>
  <footer class="site-footer">
    <div class="container footer-inner">
      <div class="footer-credit">Creado por Mike Rodr√≠guez</div>
      <nav class="footer-nav" aria-label="Footer">
        <a href="https://github.com/mikerb95" target="_blank" rel="noopener">GitHub</a>
        <a href="/terms">T√©rminos</a>
        <a href="/privacy">Privacidad</a>
        <a href="/license">Licencia</a>
      </nav>
    </div>
  </footer>
  <script src="/assets/js/header-user.js" defer></script>
  <script>
    const qs = new URLSearchParams(location.search);
    const postId = qs.get('post_id');
    let timer;
    function slugify(s){return s.toLowerCase().trim().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')}
    document.getElementById('title').addEventListener('input', (e)=>{
      const t = e.target.value; const sField = document.getElementById('slug');
      if (!sField.value) sField.value = slugify(t);
      schedule();
    });
    ;['slug','content','excerpt','cover_image_url','status'].forEach(id=>{
      document.getElementById(id).addEventListener('input', schedule);
      document.getElementById(id).addEventListener('change', schedule);
    });
    function schedule(){ clearTimeout(timer); timer = setTimeout(saveDraft, 800); }
    async function saveDraft(){
      const payload = collect();
      const url = postId ? `/api/blog/posts/${postId}` : '/api/blog/posts';
      const method = postId ? 'PUT' : 'POST';
      const t = localStorage.getItem('auth_token');
      const r = await fetch(url, { method, headers:{'Content-Type':'application/json', ...(t?{'Authorization':'Bearer '+t}:{})}, body: JSON.stringify(payload)});
    const d = await r.json();
    if (!postId && d.id){ location.search = '?post_id='+d.id; }
      const el = document.getElementById('autosave');
      el.textContent = 'Guardado a las ' + new Date().toLocaleTimeString();
    }
    function collect(){
      return {
        title: document.getElementById('title').value,
        slug: document.getElementById('slug').value,
        content: document.getElementById('content').value,
        excerpt: document.getElementById('excerpt').value,
        cover_image_url: document.getElementById('cover_image_url').value,
        status: document.getElementById('status').value,
      };
    }
    document.getElementById('save').onclick = saveDraft;
    async function load(){
      if (!postId) return;
  const t = localStorage.getItem('auth_token');
  const r = await fetch('/api/blog/posts/id/'+postId, { headers: t? { 'Authorization': 'Bearer '+t } : {} });
      const d = await r.json();
      const p = d.post;
      document.getElementById('title').value = p.title||'';
      document.getElementById('slug').value = p.slug||'';
      document.getElementById('content').value = p.content||'';
      document.getElementById('excerpt').value = p.excerpt||'';
      document.getElementById('cover_image_url').value = p.cover_image_url||'';
      document.getElementById('status').value = p.status||'draft';
    }
    load();
  </script>
</body>
</html>
