<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pago ‚Äî Petfinder</title>
  <link rel="stylesheet" href="/assets/css/landing.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner" style="max-width:720px;">
      <a class="brand" href="/">
        <span class="brand-mark">üêæ</span>
        <span class="brand-name">Petfinder</span>
      </a>
  <nav class="main-nav"><a href="/shop">Tienda</a><a href="/cart" id="cartLink" style="position:relative;">Carrito <span id="cartCount" style="position:absolute;top:-6px;right:-10px;background:#ef4444;color:#fff;border-radius:999px;padding:0 6px;font-size:12px;line-height:18px;min-width:18px;text-align:center;display:none;">0</span></a><a href="/blog">Blog</a></nav>
    </div>
  </header>
  <main class="section">
    <div class="container" style="max-width:720px;">
      <h1>Pago</h1>
      <div id="paymentFormWrap"></div>
    </div>
  </main>
  <footer class="site-footer">
    <div class="container footer-inner" style="max-width:720px;">
      <div class="footer-credit">Creado por Mike Rodr√≠guez</div>
      <nav class="footer-nav" aria-label="Footer">
        <a href="https://github.com/mikerb95" target="_blank" rel="noopener">GitHub</a>
        <a href="/terms">T√©rminos</a>
        <a href="/privacy">Privacidad</a>
        <a href="/license">Licencia</a>
      </nav>
    </div>
  </footer>
  <script>
    (async function(){
      try{
        const r = await fetch('/api/cart', {credentials:'include'});
        const d = await r.json().catch(()=>({}));
        const n = (d.items||[]).reduce((a,it)=>a+Number(it.quantity||0),0);
        const el = document.getElementById('cartCount');
        if (el) { if (n>0){ el.textContent=String(n); el.style.display='inline-block'; } else el.style.display='none'; }
      }catch(_){ }
    })();
    async function loadPayment() {
      const url = new URL(window.location.href);
      const orderId = url.searchParams.get('order');
      if (!orderId) { document.getElementById('paymentFormWrap').innerHTML = '<div class="demo-help">No se encontr√≥ la orden.</div>'; return; }
      const res = await fetch('/api/payment/' + orderId);
      const data = await res.json();
      if (!data.order) { document.getElementById('paymentFormWrap').innerHTML = '<div class="demo-help">Orden no encontrada.</div>'; return; }
      const o = data.order;
  document.getElementById('paymentFormWrap').innerHTML = `
        <div class="card">
          <div class="card-body">
            <h2>Resumen de pago</h2>
    <div>N√∫mero de orden: <strong>${o.order_number}</strong></div>
            <div>Nombre: ${o.name}</div>
            <div>Correo: ${o.email}</div>
            <div>Direcci√≥n: ${o.address}, ${o.city}</div>
            <div>Tel√©fono: ${o.phone}</div>
            <div style="margin:8px 0;font-weight:bold;">Total: ${new Intl.NumberFormat('es-CO',{style:'currency',currency:o.currency||'COP'}).format(o.total_cents/100)}</div>
            <form id="payForm">
              <label class="demo-label" for="card">Tarjeta (simulado)</label>
              <input class="input" id="card" name="card" type="text" required placeholder="1234 5678 9012 3456" maxlength="19" />
              <button class="button button-primary" id="payBtn" type="submit">Pagar</button>
              <div id="payMsg" class="demo-help" style="margin-top:8px;"></div>
            </form>
          </div>
        </div>
      `;
      document.getElementById('payForm').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('payBtn');
        const msg = document.getElementById('payMsg');
        btn.disabled = true; btn.textContent = 'Procesando‚Ä¶';
        try {
          const res = await fetch('/api/payment/' + orderId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ card: document.getElementById('card').value.trim() })
          });
          const data = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(data.error || 'Error en pago');
          window.location.href = '/order_confirmed?order=' + encodeURIComponent(orderId);
        } catch (err) {
          msg.textContent = err.message || 'Error en pago';
          msg.style.color = '#fca5a5';
        } finally {
          btn.disabled = false; btn.textContent = 'Pagar';
        }
      };
    }
    loadPayment();
  </script>
</body>
</html>
