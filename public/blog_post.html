<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Entrada - Blog</title>
  <link rel="stylesheet" href="/assets/css/style.css" />
  <style>
    .wrap{max-width:860px;margin:0 auto;padding:16px}
    .title{font-size:1.75rem;font-weight:700;margin:0 0 8px}
    .muted{color:#6b7280}
    .content{white-space:pre-wrap;line-height:1.6;margin-top:12px}
    .badge{padding:2px 8px;border:1px solid #e5e7eb;border-radius:999px;font-size:.75rem;color:#374151}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .btn{background:#111827;color:#fff;border:0;border-radius:6px;padding:8px 12px;cursor:pointer}
  .btn.active{outline:2px solid #60a5fa}
  .btn.up.active{background:#166534}
  .btn.down.active{background:#7f1d1d}
    .comment{border-top:1px solid #e5e7eb;padding:8px 0}
    .child{margin-left:16px;border-left:2px solid #e5e7eb;padding-left:8px}
    textarea,input{width:100%;border:1px solid #e5e7eb;border-radius:6px;padding:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="/blog">‚Üê Volver</a>
    <h1 class="title" id="t"></h1>
    <div class="muted" id="meta"></div>
    <div class="actions">
      <button class="btn up" id="up">üëç Me gusta</button>
      <button class="btn down" id="down">üëé No me gusta</button>
      <a class="btn" id="edit" href="#" style="display:none">Editar</a>
    </div>
    <div class="content" id="c"></div>
    <div style="margin-top:16px">
      <h3>Comentarios</h3>
      <div id="comments"></div>
      <div style="margin-top:8px">
        <textarea id="newComment" rows="3" placeholder="Escribe un comentario..."></textarea>
        <button class="btn" id="sendComment">Publicar</button>
      </div>
    </div>
  </div>
  <script>
    const slug = location.pathname.split('/').pop();
    let currentUser = null;
    async function me(){
      try { const r = await fetch('/api/me'); if(r.ok){ const d = await r.json(); currentUser = d.user; } } catch(_){ }
    }
    function fmtDate(s){ return s ? s.replace('T',' ').slice(0,16) : '' }
    async function load(){
      const t = localStorage.getItem('auth_token');
      const r = await fetch('/api/blog/posts/'+slug, { headers: t? { 'Authorization': 'Bearer '+t } : {} });
      const d = await r.json();
      document.getElementById('t').textContent = d.post.title;
      document.getElementById('meta').textContent = `por ${d.post.author_name||'An√≥nimo'} ¬∑ ${fmtDate(d.post.published_at)} ¬∑ üëç ${d.post.up_count||0} ¬∑ üëé ${d.post.down_count||0}`;
      document.getElementById('c').textContent = d.post.content;
      const edit = document.getElementById('edit');
      if (d.post.can_edit) { edit.style.display = 'inline-block'; edit.href = '/blog/editor?post_id='+d.post.id }
      // Highlight my reaction on post
      try {
        const rr = await fetch(`/api/blog/posts/${slug}/reactions`, { headers: t? { 'Authorization': 'Bearer '+t } : {} });
        const rx = await rr.json();
        document.getElementById('up').classList.toggle('active', rx.mine === 'up');
        document.getElementById('down').classList.toggle('active', rx.mine === 'down');
      } catch(_){
        document.getElementById('up').classList.remove('active');
        document.getElementById('down').classList.remove('active');
      }
      await loadComments();
    }
    function commentHtml(c){
      return `<div class="comment" data-id="${c.id}">
        <div class="muted">${c.user_name||'An√≥nimo'} ¬∑ ${fmtDate(c.created_at)}</div>
        <div>${c.body}</div>
        <div style="display:flex;gap:8px;margin-top:4px">
          <span class="badge">üëç ${c.up_count||0}</span>
          <span class="badge">üëé ${c.down_count||0}</span>
          <button class="btn" data-act="reply">Responder</button>
          <button class="btn" data-act="up">üëç</button>
          <button class="btn" data-act="down">üëé</button>
        </div>
        <div class="child" id="children-${c.id}"></div>
      </div>`
    }
    let commentsHandlerBound = false;
    async function loadComments(){
      const r = await fetch(`/api/blog/posts/${slug}/comments`);
      const d = await r.json();
      const tree = d.comments;
      const container = document.getElementById('comments');
      container.innerHTML = '';
      function renderList(list, parent){
        list.forEach(c => {
          const div = document.createElement('div');
          div.innerHTML = commentHtml(c);
          parent.appendChild(div);
          if (c.children && c.children.length){
            renderList(c.children, div.querySelector('#children-'+c.id));
          }
        })
      }
      renderList(tree, container);
      if (!commentsHandlerBound) {
        container.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const wrap = btn.closest('.comment');
        const id = wrap?.getAttribute('data-id');
        const act = btn.getAttribute('data-act');
        const t = localStorage.getItem('auth_token');
        if (act === 'reply') {
            if (wrap.querySelector('textarea')) return; // evitar duplicados
            const area = document.createElement('div');
            area.innerHTML = `<div class=\"row\"><textarea rows=\"3\" placeholder=\"Tu respuesta...\"></textarea><button class=\"btn\" data-act=\"send-reply\">Enviar</button></div>`;
            wrap.appendChild(area);
            const send = area.querySelector('[data-act=\"send-reply\"]');
            const ta = area.querySelector('textarea');
            send.onclick = async () => {
              const body = ta.value.trim(); if (!body) return;
              await fetch(`/api/blog/posts/${slug}/comments`, { method:'POST', headers:{'Content-Type':'application/json', ...(t?{'Authorization':'Bearer '+t}:{})}, body: JSON.stringify({ body, parent_id: id })});
              await loadComments();
            };
        } else if (act === 'up' || act === 'down') {
            await fetch(`/api/blog/comments/${id}/react`, { method:'POST', headers:{'Content-Type':'application/json', ...(t?{'Authorization':'Bearer '+t}:{})}, body: JSON.stringify({ reaction: act })});
            await loadComments();
        }
        });
        commentsHandlerBound = true;
      }
      // Highlight my reaction in comments
      try {
        const t = localStorage.getItem('auth_token');
        const nodes = container.querySelectorAll('.comment[data-id]');
        for (const node of nodes) {
          const id = node.getAttribute('data-id');
          const rr = await fetch(`/api/blog/comments/${id}/reactions`, { headers: t? { 'Authorization': 'Bearer '+t } : {} });
          const rx = await rr.json().catch(()=>({}));
          const upBtn = node.querySelector('button[data-act="up"]');
          const downBtn = node.querySelector('button[data-act="down"]');
          if (upBtn) upBtn.classList.toggle('active', rx.mine === 'up');
          if (downBtn) downBtn.classList.toggle('active', rx.mine === 'down');
        }
      } catch(_) {}
    }
    document.getElementById('sendComment').onclick = async () => {
      const body = document.getElementById('newComment').value.trim();
      if (!body) return;
      const t = localStorage.getItem('auth_token');
      await fetch(`/api/blog/posts/${slug}/comments`, { method:'POST', headers:{'Content-Type':'application/json', ...(t?{'Authorization':'Bearer '+t}:{})}, body: JSON.stringify({ body })});
      document.getElementById('newComment').value = '';
      loadComments();
    };
    document.getElementById('up').onclick = async () => {
      const t = localStorage.getItem('auth_token');
      await fetch(`/api/blog/posts/${slug}/react`, { method:'POST', headers:{'Content-Type':'application/json', ...(t?{'Authorization':'Bearer '+t}:{})}, body: JSON.stringify({ reaction: 'up' })});
      load();
    };
    document.getElementById('down').onclick = async () => {
      const t = localStorage.getItem('auth_token');
      await fetch(`/api/blog/posts/${slug}/react`, { method:'POST', headers:{'Content-Type':'application/json', ...(t?{'Authorization':'Bearer '+t}:{})}, body: JSON.stringify({ reaction: 'down' })});
      load();
    };
    me().then(load);
  </script>
</body>
</html>
