<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PetBnB ‚Äî Guarder√≠a y cuidadores</title>
    <link rel="stylesheet" href="/assets/css/landing.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
      .bnb-hero { padding: 40px 0 10px; }
      .filters { display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 16px; }
      .filters .input { background:#fff; color:#111; border-color:#e5e7eb; }
      .grid3 { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }
      .sitter-card { background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:12px; }
      .sitter-card h4 { margin: 0 0 6px; }
      .sitter-card .muted { display:block; margin: 2px 0 8px; }
      .sitter-photo { width: 100%; aspect-ratio: 4 / 3; border-radius:10px; object-fit: cover; border:1px solid rgba(255,255,255,0.08); background:#0b1220; }
      .badge { margin-right: 6px; }
      .modal .input, .modal select, .modal textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border:1px solid #d1d5db; background:#fff; color:#111; }
      /* Map split layout */
      .bnb-layout { display:grid; grid-template-columns: 1.2fr 1fr; gap:18px; align-items:start; }
      #bnbMap { width: 100%; height: 520px; border-radius: 12px; border:1px solid rgba(255,255,255,0.1); overflow:hidden; }
      @media (max-width: 1000px) { .bnb-layout { grid-template-columns: 1fr; } #bnbMap { height: 360px; } }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="/"><span class="brand-mark">üêæ</span><span>Petfinder</span></a>
        <button id="menuToggle" class="menu-toggle" type="button">‚ò∞</button>
        <nav class="main-nav">
          <a href="/shop">Tienda</a>
          <a href="/blog">Blog</a>
          <a href="/dashboard">Dashboard</a>
        </nav>
      </div>
    </header>

    <!-- Off-canvas mobile drawer -->
    <div id="drawerBackdrop" class="drawer-backdrop" hidden></div>
    <aside id="mobileDrawer" class="mobile-drawer" aria-hidden="true">
      <header>
        <strong>Men√∫</strong>
        <button id="drawerClose" class="close" type="button" aria-label="Cerrar">Cerrar</button>
      </header>
      <nav aria-label="Men√∫ m√≥vil">
        <a href="/">Inicio</a>
        <a href="/bnb">Guarder√≠a</a>
        <a href="/shop">Tienda</a>
        <a href="/blog">Blog</a>
        <a href="/dashboard">Panel</a>
        <button id="mLogout" type="button">Cerrar sesi√≥n</button>
      </nav>
    </aside>

    <main class="section">
      <div class="container">
        <section class="bnb-hero">
          <h1>PetBnB ‚Äî Encuentra cuidadores de confianza</h1>
          <p class="hero-subtitle">Busca por ciudad, disponibilidad y tipo de servicio. Reserva y paga con seguridad.</p>
          <div class="filters">
            <input id="qCity" class="input" placeholder="Ciudad" />
            <select id="qService" class="input">
              <option value="">Servicio‚Ä¶</option>
              <option value="boarding">Guarder√≠a (d√≠a/noche)</option>
              <option value="walking">Paseo</option>
              <option value="daycare">Cuidado diurno</option>
              <option value="vetdrive">Traslado al vet</option>
            </select>
            <input id="qFrom" class="input" type="date" />
            <input id="qTo" class="input" type="date" />
            <button id="btnSearch" class="button button-primary" type="button">Buscar</button>
          </div>
        </section>
        <section class="bnb-layout">
          <div id="sitterList" class="grid3"></div>
          <div>
            <div id="bnbMap" aria-label="Mapa de cuidadores"></div>
          </div>
        </section>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <div class="footer-credit">Creado por Mike Rodr√≠guez</div>
        <nav class="footer-nav" aria-label="Footer">
          <a href="/terms">T√©rminos</a>
          <a href="/privacy">Privacidad</a>
        </nav>
      </div>
    </footer>

  <script src="/assets/js/header-user.js" defer></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
      (function(){
        // Mobile drawer wiring
        const toggle = document.getElementById('menuToggle');
        const drawer = document.getElementById('mobileDrawer');
        const backdrop = document.getElementById('drawerBackdrop');
        const closeBtn = document.getElementById('drawerClose');
        function open(){ document.body.classList.add('drawer-open'); drawer?.setAttribute('aria-hidden','false'); toggle?.setAttribute('aria-expanded','true'); backdrop?.removeAttribute('hidden'); }
        function close(){ document.body.classList.remove('drawer-open'); drawer?.setAttribute('aria-hidden','true'); toggle?.setAttribute('aria-expanded','false'); backdrop?.setAttribute('hidden',''); }
        toggle?.addEventListener('click', open);
        closeBtn?.addEventListener('click', close);
        backdrop?.addEventListener('click', close);
        document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') close(); });
        document.getElementById('mLogout')?.addEventListener('click', (e)=>{ e.preventDefault(); localStorage.removeItem('auth_token'); window.location.href='/'; });

        // Simple fetch of sitters (public)
        const list = document.getElementById('sitterList');
        const btn = document.getElementById('btnSearch');
        // Map init (Leaflet)
        let map, cluster;
        function ensureMap() {
          if (map) return map;
          map = L.map('bnbMap', { zoomControl: true });
          const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
          });
          tiles.addTo(map);
          cluster = L.markerClusterGroup();
          map.addLayer(cluster);
          map.setView([4.65, -74.1], 5); // Colombia approx
          return map;
        }
        function clearMarkers() { if (cluster) cluster.clearLayers(); }
        function addMarker(s) {
          if (s.lat == null || s.lng == null) return;
          const m = L.marker([s.lat, s.lng]);
          const services = (s.services || '').split(',').filter(Boolean).map(x=>x.trim()).join(' ¬∑ ');
          const city = s.city || '';
          const addr = s.address || '';
          m.bindPopup(`<div style="min-width:220px">
            ${s.photo_url ? `<img src="${s.photo_url}" alt="${s.name}" style="width:100%; border-radius:8px; margin-bottom:6px;">` : ''}
            <strong>${s.name}</strong><br>
            <small>${city}${addr ? ' ‚Ä¢ ' + addr : ''}</small><br>
            <div style="margin:6px 0;">${services}</div>
            <button class="button button-primary" data-book="${s.id}">Reservar</button>
          </div>`);
          m._sitter = s;
          cluster.addLayer(m);
          return m;
        }
        async function load(){
          const params = new URLSearchParams();
          const city = document.getElementById('qCity').value.trim(); if (city) params.set('city', city);
          const svc = document.getElementById('qService').value; if (svc) params.set('service', svc);
          const from = document.getElementById('qFrom').value; if (from) params.set('from', from);
          const to = document.getElementById('qTo').value; if (to) params.set('to', to);
          list.innerHTML = 'Cargando‚Ä¶';
          const res = await fetch('/api/bnb/sitters?' + params.toString());
          if (!res.ok) { list.textContent = 'No se pudo cargar'; return; }
          const data = await res.json();
          if (!data.sitters || !data.sitters.length) { list.textContent = 'No hay resultados.'; return; }
          list.innerHTML = '';
          ensureMap();
          clearMarkers();
          const bounds = L.latLngBounds([]);
          for (const s of data.sitters) {
            const el = document.createElement('div');
            el.className = 'sitter-card';
            el.innerHTML = `
              ${s.photo_url ? `<img class="sitter-photo" src="${s.photo_url}" alt="${s.name}">` : ''}
              <h4>${s.name}</h4>
              <span class="muted">${s.city || ''} ‚Ä¢ ${s.experience_years ? (s.experience_years + ' a√±os de experiencia') : 'Sin especificar'}</span>
              <div class="chips">
                ${(s.services || '').split(',').filter(Boolean).map(x=>`<span class='chip'>${x.trim()}</span>`).join(' ')}
              </div>
              <div style="display:flex; gap:8px;flex-wrap:wrap; margin-top:8px;">
                <button class="button" data-view="${s.id}">Ver perfil</button>
                <button class="button button-primary" data-book="${s.id}">Reservar</button>
              </div>
            `;
            list.appendChild(el);
            const marker = addMarker(s);
            if (marker && s.lat != null && s.lng != null) bounds.extend([s.lat, s.lng]);
          }
          if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
          // Bind book buttons -> prompt minimal flow
          list.querySelectorAll('button[data-book]').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-book');
              const token = localStorage.getItem('auth_token');
              if (!token) { alert('Inicia sesi√≥n para reservar'); window.location.href='/login'; return; }
              const from = prompt('Fecha inicio (YYYY-MM-DD)');
              const to = prompt('Fecha fin (YYYY-MM-DD)');
              if (!from || !to) return;
              const notes = prompt('Notas para el cuidador (opcional)') || undefined;
              const res = await fetch('/api/bnb/bookings', { method:'POST', headers:{ 'Authorization':'Bearer ' + token, 'Content-Type':'application/json' }, body: JSON.stringify({ sitter_id: id, start_date: from, end_date: to, notes }) });
              if (!res.ok) { const e = await res.json().catch(()=>({})); alert(e.error || 'No se pudo reservar'); return; }
              alert('Reserva creada. Revisa tu dashboard.');
            });
          });
          // Click on list card centers the map
          list.querySelectorAll('.sitter-card').forEach(card => {
            const id = card.querySelector('button[data-book]')?.getAttribute('data-book');
            card.addEventListener('click', () => {
              const s = (data.sitters || []).find(x => String(x.id) === String(id));
              if (s && s.lat != null && s.lng != null && map) {
                map.flyTo([s.lat, s.lng], 14, { duration: 0.6 });
              }
            });
          });
        }
        btn?.addEventListener('click', load);
        load();
      })();
    </script>
  </body>
  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments) };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
</html>
