<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout ‚Äî Petfinder</title>
  <link rel="stylesheet" href="/assets/css/landing.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner" style="max-width:720px;">
      <a class="brand" href="/">
        <span class="brand-mark">üêæ</span>
        <span class="brand-name">Petfinder</span>
      </a>
  <nav class="main-nav"><a href="/shop">Tienda</a><a href="/cart" id="cartLink" style="position:relative;">Carrito <span id="cartCount" style="position:absolute;top:-6px;right:-10px;background:#ef4444;color:#fff;border-radius:999px;padding:0 6px;font-size:12px;line-height:18px;min-width:18px;text-align:center;display:none;">0</span></a><a href="/blog">Blog</a><a id="loginLink" href="/login">Ingresar</a><span id="hdrName" style="margin-left:8px;opacity:.9;"></span></nav>
    </div>
  </header>
  <main class="section">
    <div class="container" style="max-width:720px;">
      <h1>Checkout</h1>
  <form id="checkoutForm" class="demo-form" novalidate>
        <label class="demo-label" for="name">Nombre completo</label>
        <input class="input" id="name" name="name" type="text" required placeholder="Tu nombre" />
        <label class="demo-label" for="email">Correo electr√≥nico</label>
        <input class="input" id="email" name="email" type="email" required placeholder="tu@correo.com" />
        <label class="demo-label" for="address">Direcci√≥n de env√≠o</label>
        <input class="input" id="address" name="address" type="text" required placeholder="Direcci√≥n completa" />
        <label class="demo-label" for="city">Ciudad</label>
        <input class="input" id="city" name="city" type="text" required placeholder="Ciudad" />
        <label class="demo-label" for="phone">Tel√©fono</label>
        <input class="input" id="phone" name="phone" type="tel" required placeholder="Tel√©fono" />
        <div id="orderSummary" style="margin:16px 0;"></div>
        <div class="card" style="margin:12px 0;">
          <div class="card-body">
            <label class="demo-label" for="coupon">¬øTienes un cup√≥n?</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input class="input" id="coupon" name="coupon" type="text" placeholder="C√≥digo de descuento" style="flex:1;" />
              <button class="button" id="applyCoupon" type="button">Aplicar</button>
            </div>
            <div id="couponMsg" class="demo-help" style="margin-top:8px;"></div>
          </div>
        </div>
        <button class="button button-primary" id="submitBtn" type="submit">Continuar al pago</button>
        <div id="msgStatus" class="demo-help" role="status" aria-live="polite" style="margin-top:10px"></div>
      </form>
    </div>
  </main>
  <footer class="site-footer">
    <div class="container footer-inner" style="max-width:720px;">
      <div class="footer-credit">Creado por Mike Rodr√≠guez</div>
      <nav class="footer-nav" aria-label="Footer">
        <a href="https://github.com/mikerb95" target="_blank" rel="noopener">GitHub</a>
        <a href="/terms">T√©rminos</a>
        <a href="/privacy">Privacidad</a>
        <a href="/license">Licencia</a>
      </nav>
    </div>
  </footer>
  <script>
    (async function(){
      try{
        const r = await fetch('/api/cart', {credentials:'include'});
        const d = await r.json().catch(()=>({}));
        const n = (d.items||[]).reduce((a,it)=>a+Number(it.quantity||0),0);
        const el = document.getElementById('cartCount');
        if (el) { if (n>0){ el.textContent=String(n); el.style.display='inline-block'; } else el.style.display='none'; }
      }catch(_){ }
    })();
  async function loadSummary() {
      const res = await fetch('/api/cart');
      const data = await res.json();
      const items = data.items || [];
      let html = '';
      let total = 0;
      const fmt = (cur, v) => new Intl.NumberFormat('es-CO',{style:'currency',currency:cur||'COP'}).format(v);
      items.forEach(item => {
        total += item.price_cents * item.quantity;
        html += `<div>${item.name} x${item.quantity} ‚Äî ${fmt(item.currency, (item.price_cents*item.quantity)/100)}</div>`;
      });
  html += `<div style='font-weight:bold;margin-top:8px;'>Total: ${fmt('COP', total/100)}</div>`;
      document.getElementById('orderSummary').innerHTML = html;
    }
    loadSummary();
    const form = document.getElementById('checkoutForm');
    const btn = document.getElementById('submitBtn');
    const msg = document.getElementById('msgStatus');
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      msg.textContent = '';
      btn.disabled = true; btn.textContent = 'Procesando‚Ä¶';
      const payload = {
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        address: document.getElementById('address').value.trim(),
        city: document.getElementById('city').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        coupon_code: (document.getElementById('coupon').value||'').trim() || undefined
      };
      try {
        const res = await fetch('/api/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(data.error || 'Error en checkout');
        window.location.href = '/payment?order=' + encodeURIComponent(data.order_id);
      } catch (err) {
        msg.textContent = err.message || 'Error en checkout';
        msg.style.color = '#fca5a5';
      } finally {
        btn.disabled = false; btn.textContent = 'Continuar al pago';
      }
    });

    // Optional UX: basic coupon validation with a dry run by calling orders endpoint is out-of-scope; show local note
    document.getElementById('applyCoupon').addEventListener('click', ()=>{
      const code = (document.getElementById('coupon').value||'').trim();
      const el = document.getElementById('couponMsg');
      if (!code) { el.textContent = 'Ingresa un c√≥digo.'; el.style.color = '#fca5a5'; return; }
      el.textContent = 'El cup√≥n se validar√° al crear la orden.'; el.style.color = '#9ca3af';
    });
  </script>
  <script>
    // Mostrar nombre en el header si hay sesi√≥n iniciada
    (async function(){
      try {
        const t = localStorage.getItem('auth_token');
        if (!t) return;
        const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + t } });
        if (!res.ok) return;
        const data = await res.json().catch(()=>({}));
        const name = data && data.user && data.user.name;
        if (name) {
          const el = document.getElementById('hdrName');
          if (el) el.textContent = 'Hola, ' + name;
          const login = document.getElementById('loginLink');
          if (login) login.style.display = 'none';
        }
      } catch(_){ }
    })();
  </script>
</body>
</html>
